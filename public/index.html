<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Portfolio Nano V5 ðŸ“ˆ</title>
    <style>
        :root {
            --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --accent: #58a6ff;
            --border: #30363d; --green: #3fb950; --red: #f85149;
        }
        body {
            font-family: -apple-system, sans-serif; background-color: var(--bg);
            color: var(--text); margin: 0; padding: 16px; padding-bottom: 80px;
        }
        .total-block {
            background: linear-gradient(135deg, #1f2937, #0d1117);
            border: 1px solid var(--border); border-radius: 12px; padding: 20px;
            margin-bottom: 24px; text-align: center;
        }
        .total-val { font-size: 2.2rem; font-weight: 800; color: #fff; }
        .total-gain { font-size: 1rem; font-weight: 600; margin-top: 5px; }

        .card {
            background: var(--card); border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; margin-bottom: 12px; display: grid; grid-template-columns: 1fr 80px 100px;
            gap: 8px; position: relative; align-items: center;
        }
        .info { display: flex; flex-direction: column; overflow: hidden;}
        .symbol { font-weight: bold; font-size: 1.1rem; color: var(--accent); }
        .name { font-size: 0.8rem; color: #8b949e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .details { font-size: 0.75rem; color: #8b949e; margin-top: 4px; }
        
        .price-block { text-align: right; }
        .price { font-size: 1.1rem; font-weight: bold; color: #f0f6fc; }
        .day-change { font-size: 0.7rem; color: #8b949e; }
        .gain-val { font-size: 0.8rem; font-weight: 600; margin-top: 2px; }
        
        /* Sparkline */
        .chart { width: 80px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .chart svg { width: 100%; height: 100%; overflow: visible; }
        .line-up { stroke: var(--green); fill: none; stroke-width: 2; }
        .line-down { stroke: var(--red); fill: none; stroke-width: 2; }
        
        .up { color: var(--green); }
        .down { color: var(--red); }
        .bg-up { background: rgba(63, 185, 80, 0.15); color: var(--green); padding: 2px 6px; border-radius: 4px;}
        .bg-down { background: rgba(248, 81, 73, 0.15); color: var(--red); padding: 2px 6px; border-radius: 4px;}

        .btn-add {
            position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
            background: var(--accent); color: white; border: none; font-size: 2rem; box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4); cursor: pointer;
        }
        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: var(--card); padding: 24px; border-radius: 12px; width: 85%; max-width: 320px; border: 1px solid var(--border); }
        input { width: 100%; padding: 12px; margin: 8px 0; background: #0d1117; border: 1px solid var(--border); color: white; border-radius: 8px; box-sizing: border-box; }
        .actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px; }
        button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-save { background: var(--accent); color: white; }
    </style>
</head>
<body>
    <div class="total-block">
        <div style="color:#8b949e; font-size:0.8rem">VALORISATION (EUR)</div>
        <div class="total-val" id="total-val">---</div>
        <div class="total-gain" id="total-gain">---</div>
        <div style="font-size:0.7rem; color:#444; margin-top:5px; display:flex; justify-content:center; align-items:center; gap:8px;">
            <span>Taux EUR/USD : <span id="forex-rate">-</span></span>
            <button onclick="load()" style="background:transparent; border:1px solid #333; color:#8b949e; border-radius:4px; cursor:pointer; padding:2px 6px;">ðŸ”„</button>
        </div>
    </div>

    <div id="list">Chargement...</div>
    <button class="btn-add" onclick="openModal()">+</button>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0">Position</h3>
            <input type="text" id="symbol" placeholder="Symbole (ex: MEDCL.PA)" />
            <input type="number" id="qty" placeholder="QuantitÃ©" />
            <input type="number" id="pru" placeholder="PRU en EUROS (ex: 18.69)" step="0.01" />
            <input type="password" id="pwd" placeholder="Mot de passe (nano123)" />
            <div class="actions">
                <button onclick="closeModal()" style="background:transparent;color:#8b949e">Annuler</button>
                <button class="btn-save" onclick="saveStock()">Enregistrer</button>
            </div>
            <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px; text-align:center;">
                <button onclick="deleteStock()" style="background:transparent;color:var(--red);font-size:0.8rem">Supprimer</button>
            </div>
        </div>
    </div>

    <script>
        // Fonction pour dessiner le mini-graphique (Sparkline)
        function createSparkline(history, isUp) {
            if (!history || history.length < 2) return '';
            
            const min = Math.min(...history);
            const max = Math.max(...history);
            const range = max - min || 1;
            
            // On normalise les points entre 0 et 100% de la hauteur/largeur
            const width = 80;
            const height = 40;
            const step = width / (history.length - 1);
            
            let pathD = `M 0 ${height - ((history[0] - min) / range * height)}`;
            
            for (let i = 1; i < history.length; i++) {
                const x = i * step;
                const y = height - ((history[i] - min) / range * height);
                pathD += ` L ${x} ${y}`;
            }
            
            const colorClass = isUp ? 'line-up' : 'line-down';
            return `<svg viewBox="0 -5 ${width} ${height+10}"><path d="${pathD}" class="${colorClass}" /></svg>`;
        }

        async function load() {
            const btn = document.querySelector('button[onclick="load()"]');
            if(btn) btn.innerHTML = 'â³';

            try {
                const res = await fetch('/api/stocks?t=' + Date.now());
                const data = await res.json();
                render(data.stocks, data.forex);
            } catch (e) {
                document.getElementById('list').innerHTML = 'Erreur';
            } finally {
                if(btn) btn.innerHTML = 'ðŸ”„';
            }
        }

        function render(stocks, forex) {
            const list = document.getElementById('list');
            list.innerHTML = '';
            let totalEur = 0;
            let totalGainEur = 0;

            document.getElementById('forex-rate').innerText = forex.toFixed(4);

            stocks.forEach(s => {
                if (s.error) return;
                
                totalEur += s.totalValue;
                totalGainEur += s.gain;

                const isUp = s.dayChange >= 0; // Couleur du graphique dÃ©pend de la variation du jour
                const currency = s.currency === 'USD' ? '$' : 'â‚¬';
                const pruCurrency = 'â‚¬'; 

                // GÃ©nÃ©ration du graphique
                const sparkline = createSparkline(s.history, isUp);

                const html = `
                    <div class="card" onclick="edit('${s.symbol}', ${s.quantity}, ${s.pru})">
                        <div class="info">
                            <span class="symbol">${s.symbol.replace('.PA','')}</span>
                            <span class="name">${s.name.substring(0,12)}..</span>
                            <span class="details">${s.quantity} x ${s.pru} ${pruCurrency}</span>
                        </div>
                        <div class="chart">
                            ${sparkline}
                        </div>
                        <div class="price-block">
                            <div class="price">${s.price.toFixed(2)} ${currency}</div>
                            <span class="day-change ${isUp?'up':'down'}">
                                ${isUp?'+':''}${s.dayChange.toFixed(2)}%
                            </span>
                            <div class="gain-val ${s.gain>=0?'bg-up':'bg-down'}">
                                ${s.gain>=0?'+':''}${s.gain.toFixed(0)} â‚¬
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });

            document.getElementById('total-val').innerText = totalEur.toLocaleString('fr-FR', {style:'currency', currency:'EUR', maximumFractionDigits:0});
            
            const isTotalUp = totalGainEur >= 0;
            document.getElementById('total-gain').innerHTML = `
                <span class="${isTotalUp?'bg-up':'bg-down'}">
                    ${isTotalUp?'+':''}${totalGainEur.toFixed(0)} â‚¬
                </span>
            `;
        }

        const modal = document.getElementById('modal');
        const inpSymbol = document.getElementById('symbol');
        const inpQty = document.getElementById('qty');
        const inpPru = document.getElementById('pru');
        const inpPwd = document.getElementById('pwd');

        function openModal() {
            inpSymbol.value = ''; inpQty.value = ''; inpPru.value = '';
            modal.style.display = 'flex';
        }
        function edit(s, q, p) {
            inpSymbol.value = s; inpQty.value = q; inpPru.value = p;
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }

        async function saveStock() {
            const res = await fetch('/api/portfolio', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: inpSymbol.value.toUpperCase(),
                    quantity: inpQty.value,
                    pru: inpPru.value,
                    password: inpPwd.value
                })
            });
            if(res.ok) { closeModal(); load(); } else alert("Erreur");
        }
        
        async function deleteStock() {
            if(!confirm("Supprimer ?")) return;
            const res = await fetch('/api/portfolio', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ symbol: inpSymbol.value, password: inpPwd.value })
            });
            if(res.ok) { closeModal(); load(); }
        }

        load();
    </script>
</body>
</html>
